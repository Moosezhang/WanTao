@{
    ViewBag.Title = "微信用户管理";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}


<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
<div class="wz">
        您当前所在的位置：微信用户管理
</div>
<div id="WxUser">
    <el-row style="margin-top:10px;margin-left:10px">
        <el-col span="24">
            <div>
                <el-input v-model="txtName" id="txtName" placeholder="请输入用户名" clearable style="width:200px;"></el-input>
                <el-input v-model="txtPhone" id="txtPhone" placeholder="请输入手机号" clearable style="width:200px;"></el-input>
                <el-date-picker v-model="stratDate"
                                type="date"
                                placeholder="选择日期"
                                format="yyyy 年 MM 月 dd 日"
                                value-format="yyyy-MM-dd">
                </el-date-picker>
                <el-date-picker v-model="endDate"
                                type="date"
                                placeholder="选择日期"
                                format="yyyy 年 MM 月 dd 日"
                                value-format="yyyy-MM-dd">
                </el-date-picker>
                <el-button size="mini" style="margin-left:10px" type="primary"
                           v-on:click="QueryData()">查询</el-button>                
            </div>
        </el-col>
    </el-row>
    <div style="margin-top:30px">
        <template>
            <el-table border stripe
                      v-bind:data="WxUserData.slice((currentPage-1)*pagesize,currentPage*pagesize)"
                      v-bind:default-sort="{prop: 'CreateTime', order: 'descending'}"
                      style="width: 100%">
                <el-table-column prop="Nickname"
                                 label="昵称">
                </el-table-column>

                <el-table-column prop="Phone"
                                 label="手机号">
                </el-table-column>
                <el-table-column prop="Sex"
                                 label="性别">
                </el-table-column>                
                <el-table-column fixed="right"
                                 label="操作" header-align="center" align="center">
                    <template slot-scope="scope">
                        <el-button size="mini"
                                   v-on:click="handleDetail(scope.row.Openid)">查看详情</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-pagination 
            				v-on:size-change="handleSizeChange"
							v-on:current-change="handleCurrentChange"
						    :current-page="currentPage"
						    :page-sizes="[10, 20, 50, 100]"
						    :page-size="pagesize"
						    layout="total, prev, pager, next"
						    :total="WxUserData.length">
            </el-pagination>
        </template>

    </div>

    <el-dialog title="用户信息" v-bind:visible.sync="dialogOrderFormVisible" v-model="dialogOrderFormVisible" style="height:1000px;">
    	<el-tabs v-model="activeName" type="border-card">
    		<el-tab-pane label="用户详情" name="WxUserInfo">
 			    <el-form model="form" style="height:auto" label-width="80px">
		            <el-row>
		                <el-col span="12" style="display: none;">
		                    <el-form-item label="Id">
		                        <el-input v-model="form.WxUserId" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>
		                <el-col span="12">
		                    <el-form-item label="昵  称">
		                        <el-input v-model="form.Nickname" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>
		                 <el-col span="12">
		                    <el-form-item label="电  话">
		                        <el-input v-model="form.Phone" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>
		                <el-col span="12">
		                    <el-form-item label="性  别">
		                        <el-input v-model="form.Sex" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>                
		                <el-col span="12">
		                    <el-form-item label="所在城市">
		                        <el-input v-model="form.City" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>
		                <el-col span="12">
		                    <el-form-item label="所在国家">
		                        <el-input v-model="form.Country" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>
		                <el-col span="12">
		                    <el-form-item label="所在省份">
		                        <el-input v-model="form.Province" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>
		                <el-col span="12">
		                    <el-form-item label="用户语言">
		                        <el-input v-model="form.UserLanguage" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>
		                <el-col span="12">
		                    <el-form-item label="备  注">
		                        <el-input v-model="form.Remark" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>		                
		                <el-col span="12">
		                    <el-form-item label="积  分">
		                        <el-input v-model="form.Points" disabled="true"  style="width:220px;" clearable></el-input>
		                    </el-form-item>
		                </el-col>
		            </el-row>
		        </el-form>  
        	</el-tab-pane>
        	<el-tab-pane label="已购课程" name="ClassInfo">
		        <template>
		            <el-table border stripe
		                      v-bind:data="detailData.slice((currentPage-1)*pagesize,currentPage*pagesize)"
		                      v-bind:default-sort="{prop: 'DictionaryName', order: 'descending'}"
		                      style="width: 100%">
		                <el-table-column prop="GoodsId"
                                 label="商品ID"
                                 v-if="false">
		                </el-table-column
		
		                <el-table-column prop="OrderId"
		                                 label="订单ID"
		                                 v-if="false">
		                </el-table-column>
		                <el-table-column prop="ClassName"
		                                 label="课程名称">
		                </el-table-column>
		                <el-table-column prop="Price"
		                                 label="实际价格">
		                </el-table-column>
		                <el-table-column prop="CreateTime"
		                                 label="购买时间"
		                                 :formatter="dateFormat">
		                </el-table-column>
		            </el-table> 
		            <el-pagination 
		            				v-on:size-change="handleSizeChange"
									v-on:current-change="handleCurrentChange"
								    :current-page="currentPage"
								    :page-sizes="[10, 20, 50, 100]"
								    :page-size="pagesize"
								    layout="total, prev, pager, next"
								    :total="detailData.length">
		            </el-pagination>
		        </template>
        	</el-tab-pane>
    	</el-tabs>	
    </el-dialog>
</div>

<script>
    var orderVue;
    $(function () {
        NProgress.done();
        WxUserVue = new Vue({
            el: "#WxUser",
            data: {
            	activeName:'WxUserInfo',
                WxUserData: [],
                detailData: [],
                txtName: "",
                txtPhone: "",
                stratDate:'',
                endDate:'',
                dialogOrderFormVisible: false,
                form: {},
                currentPage:1,
        		pagesize:8,
            },
            created: function () {
                this.QueryData();
            },
            methods: {
            	dateFormat: function (row, column) {
                    var date = row[column.property];
                    if (date == undefined) {
                        return "";
                    }
                    return new Date(parseInt(date.substr(6, 13))).toLocaleDateString();
                    //return moment(date).format("YYYY-MM-DD HH:mm:ss");
                    //return new Date(parseInt(date.substr(6, 13))).toLocaleDateString();
                },
                handleDetail: function (Openid) {
                    this.GetWxUserByOpenid(Openid);
                    this.GetOrderGoodsListByOpenId(Openid);
                    this.dialogOrderFormVisible = true;
                },
                GetWxUserByOpenid:function(Openid){
                	var _self = this;
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        contentType: "application/json",
                        url: "/WxUser/GetWxUserByOpenid?pGuid=" + guid(),
                        data: {
                            Openid: Openid
                        },
                        success: function (result) {
                            _self.form = result;
                        }
                    });
                },
                GetOrderGoodsListByOpenId:function(Openid){
                	var _self = this;
                	$.ajax({
                        type: "get",
                        dataType: "json",
                        contentType: "application/json",
                        url: "/Order/GetOrderGoodsListByOpenId?pGuid=" + guid(),
                        data: {
                            Openid: Openid
                        },
                        success: function (result) {
                            _self.detailData = result;
                        }
                    });
                },
                QueryData: function () {
                    var _self = this;
                    var userName = this.txtName;
                    var Phone = this.txtPhone;
                    var startDate = this.stratDate;
                    var endDate = this.endDate;
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        contentType: "application/json",
                        url: "/WxUser/GetWxUserListByCondition?pGuid=" + guid(),
                        data: {
                            name: userName,
                            phone: Phone,
                            startDate: startDate,
                            endDate: endDate
                        },
                        success: function (result) {
                            _self.WxUserData = result;
                        },
                        error: function (json) {
                            _self.$message.error('加载用户信息失败');
                        }
                    });
                },
                dateFormat: function (row, column) {
                    var date = row[column.property];
                    if (date == undefined) {
                        return "";
                    }
                    //return moment(date).format("YYYY-MM-DD HH:mm:ss");
                    return new Date(parseInt(date.substr(6, 13))).toLocaleDateString();
                },                
                handleSizeChange: function (size) {
			        this.pagesize = size;
			    },
			    handleCurrentChange: function(currentPage){
			        this.currentPage = currentPage;
			    }
            }

        });
    })

    function guid() {
        function S4() {
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        }
        return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
    }


</script>