
@{
     ViewBag.Title = "限时团购";
}


<style>
.div-inline { 
	display:inline;
	float: left;
	text-align:center;
	line-height: 35px;
} 

ul li{
list-style-type:none;
}

</style>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>限时团购</title>
</head>
<body>
  	<header data-am-widget="header" class="am-header am-header-default" style="background-color: white;">
	  <div class="am-header-left am-header-nav">
		    <a href="javascript:window.history.back(); " class="">
		  		<img class="am-header-icon-custom" src="~/Images/icon/返回.png" alt=""/>
		  	</a>
	  </div>
	   <h3 class="am-header-title" style="color: black;padding-top: 15px;font-size: 18px;">
          限时团购
      </h3>
	</header>
  	<hr style="margin-top: 0px;margin-bottom: 5px;"/>
  	<div id="detail" model="form">
  		<form class="am-form">
	        <fieldset>	
            	<div class="am-input-group" style="width: 100%; height: 180px;">
                   	<div >
                   		<img  :src="form.ClassImages" style="width: 100%;height: 180px;">                   		   
                   	</div>	
                </div>
                <p >
                	<div style="font-size: 20px;margin-left: 10px;">{{form.ClassAbstract}}</div>
                	<div style="font-size: 15px;margin-top: 5px;color: #444444;margin-left: 10px;">剩余时间：
                	 	<span style="color: red;" id="_d">00</span>  
			         	<span style="color: red;" id="_h">00</span>  
			         	<span style="color: red;" id="_m">00</span>  
			        	<span style="color: red;" id="_s">00</span> 
                	</div>
                </p>
                
               	<hr />
               
	            <div style="margin-top: 10px;margin-left: 10px;">
	            	<div style="font-size: 15px;">
						  <span style="color: #4395ff;">{{form.NowCount}}</span>人正在拼图，还差<span style="color: #4395ff;">{{form.NeedCount-form.NowCount}}</span>人满团，立即团购
						  <img style="height: 15px;" class="am-header-icon-custom" src="~/Images/icon/喇叭.png" alt=""/>
	            	</div>
					<header class="am-topbar  am-topbar-fixed-bottom" style="height: 50px;">
						<div class="div-inline" style="margin-top: 8px;margin-left: 18px;color: red;font-size: 20px;" >
							拼团价:¥{{form.GroupPrice}}
						</div>	
						<div class="div-inline" style="margin-top: 8px;margin-left: 10px;color: #444444;font-size: 15px;" >
							<span style="text-decoration:line-through;">原价:¥{{form.ClassPrice}}</span>
						</div>	
						
						<div class="div-inline" v-on:click="GoBuy(form.ClassId,form.GroupPrice)" style="line-height: 2.5;float:right;width: 30%;color: white;font-size: 20px;height: 100%;background-color: #4395ff;"  >
							立即拼购
						</div>
									
					</header>
					
	            </div>
	        </fieldset>
	    </form>  	
        
		
  	</div>
  	



	
</body>


<script>
	var openid = '@ViewBag.Openid';
	var classid='@ViewBag.ClassId';
	var videoVue=new Vue({
		el:"#myVideo",
		data:{
			currVideoUrl:"",
		}
	});
	var detailVue=new Vue({
		el:"#detail",
		data:{
			form:{},
			orderNo:"",
			endTime:"",
		},
		created: function () {
                this.Query();
               
         },
         methods:{
         	Query:function () {  
			    var _self = this;
                $.ajax({
                    type: "get",
                    dataType: "json",
                    contentType: "application/json",
                    url: "/WxOrder/GetGbClass?pGuid=" + guid(),
                    data: {
                        classId:classid
                    },
                    success: function (result) { 
                        _self.form=result;    
                        _self.endTime=_self.ChangeDateFormat(result.EndTime);
                        countTime();
                    },
                    error: function (json) {
                        _self.$message.error('查询失败');
                    }
                }); 
                $.ajax({
                    type: "get",
                    dataType: "json",
                    contentType: "application/json",
                    url: "/WxClass/GetChaptersByClassKey?pGuid=" + guid(),
                    data: {
                        classid:classid
                    },
                    success: function (result) { 
                        _self.capData = result; 
                    },
                    error: function (json) {
                        _self.$message.error('查询失败');
                    }
                });  
			},
			GoBuy:function(classId,price)
			{
				var _self = this;	
				var param={
					classids:"",
					openid:openid,
					source:"3",
					price:price
				}
				
				param.classids=classId+"|";
				
				$.ajax({
                    type: "post",
                    dataType: "json",
                    url: "/WxOrder/AddOrder?pGuid=" + guid(),
                    data:param,
                    success: function (result) {
                    	_self.orderNo=result;
                    	window.location.href = "/WxOrder/Index?openid=" + openid+"&&orderNo="+_self.orderNo;
                    },
                    error: function (json) {
                        
                    }
                });
				
			},
			 ChangeDateFormat:function(timeSpan) {
				    var timeSpan = timeSpan.replace('Date','').replace('(','').replace(')','').replace(/\//g,'');
				    var d = new Date(parseInt(timeSpan));
				    return d;
			},
			
         }
	});
	
	 function guid() {
        function S4() {
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        }
        return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
    }
	 
	 
	 
	 function countTime() {  
              //获取当前时间  
              var date = new Date();  
             var now = date.getTime();  
             //设置截止时间  
             var str=detailVue.endTime;
             var endDate = new Date(str); 
             var end = endDate.getTime();               
             //时间差  
             var leftTime = end-now; 
             //定义变量 d,h,m,s保存倒计时的时间  
             var d,h,m,s;  
             if (leftTime>=0) {  
                 d = Math.floor(leftTime/1000/60/60/24);  
                 h = Math.floor(leftTime/1000/60/60%24);  
                 m = Math.floor(leftTime/1000/60%60);  
                 s = Math.floor(leftTime/1000%60);                     
             }  
             //将倒计时赋值到div中  
             document.getElementById("_d").innerHTML = d+"天";  
             document.getElementById("_h").innerHTML = h+"时";  
             document.getElementById("_m").innerHTML = m+"分";  
             document.getElementById("_s").innerHTML = s+"秒";  
             //递归每秒调用countTime方法，显示动态时间效果  
             setTimeout(countTime,1000);  
   
         }  

	
</script>
