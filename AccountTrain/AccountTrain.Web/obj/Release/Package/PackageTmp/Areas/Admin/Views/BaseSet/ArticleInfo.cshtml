@{
    ViewBag.Title = "文章管理";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}


<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
<div class="wz">
        您当前所在的位置：文章管理
</div>
<div id="Article">
    <el-row style="margin-top:10px;margin-left:10px">
        <el-col span="24">
            <div>
                <el-input v-model="txtName" id="txtName" placeholder="请输入文章标题" clearable style="width:200px;"></el-input>
                <el-button size="mini" style="margin-left:10px" type="primary"
                           v-on:click="QueryData()">查询</el-button>
                <el-button size="mini" type="warning"
                           v-on:click="handleAdd()">新增</el-button>
            </div>
        </el-col>
    </el-row>

    <div style="margin-top:5px;margin-left:10px">
        <template>
            <el-table border stripe
                      v-bind:data="tableData.slice((currentPage-1)*pagesize,currentPage*pagesize)"
                      v-bind:default-sort="{prop: 'CreateTime', order: 'descending'}"
                      style="width: 100%">
                <el-table-column prop="ArticleTitle"
                                 label="文章标题">
                </el-table-column>
                 <el-table-column prop="ArticleType"
                                 label="文章类型"
                                 width="100">
                </el-table-column>
                <el-table-column label="缩略图"
                	width="100">
                 	<template slot-scope="scope">
			        	<img v-bind:src="scope.row.ImageUrl" width="50px" height="50px">			        	
			      	</template>
                </el-table-column>
                <el-table-column fixed="right"
                                 label="操作"
                                 width="200" header-align="center" align="center">
                    <template slot-scope="scope">
                        <el-button size="mini"
                        			type="primary"
                                   v-on:click="handleEdit(scope.row.ArticleId)">编辑</el-button>
                        <el-button v-if="scope.row.Status==1" size="mini"
                                   type="danger"
                                   v-on:click="handleDisable(scope.row.ArticleId,0)">删除</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-pagination 
            				v-on:size-change="handleSizeChange"
							v-on:current-change="handleCurrentChange"
						    :current-page="currentPage"
						    :page-sizes="[10, 20, 50, 100]"
						    :page-size="pagesize"
						    layout="total, prev, pager, next"
						    :total="tableData.length">
            </el-pagination>
        </template>

    </div>

    <el-dialog title="文章信息" v-bind:visible.sync="dialogArticleFormVisible" v-model="dialogArticleFormVisible" style="height:600px;">
        <el-form model="form" style="margin-top:-20px;height:auto" label-width="80px">
            <el-row>
            	<el-col span="24">
                    <el-form-item label="文章标题">
                        <el-input v-model="form.ArticleTitle"  clearable></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col span="12" style="display: none;">
                    <el-form-item label="Id">
                        <el-input v-model="form.ArticleId"  clearable></el-input>
                    </el-form-item>
                </el-col>
                <el-col span="12">
	                <el-form-item label="文章类别">
	                    <el-cascader
					    expand-trigger="click"
					    :options="nodeList"
					    v-model="selectedOptions"
					    :show-all-levels="false">
					  	</el-cascader>
	                </el-form-item>
        		</el-col>
                <el-col span="24">
                    <el-form-item label="文章类型">
                        <el-select v-model="form.ArticleType" placeholder="请选择文章类型" >
                            <el-option v-for="item in DicData"
                                       v-bind:key="item.ItemKey"
                                       v-bind:label="item.ItemValue"
                                       v-bind:value="item.ItemKey">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col span="12">
                    <el-form-item label="开始时间">
                    	<el-date-picker
					      v-model="form.StartTime"
					      type="datetime"
					      format="yyyy-MM-dd HH:mm:ss"
					      value-format="yyyy-MM-dd HH:mm:ss">
					    </el-date-picker>
                    </el-form-item>
                </el-col>
                <el-col span="12">
                    <el-form-item label="截止时间">
                    	<el-date-picker
					      v-model="form.EndTime"
					      type="datetime"
					      format="yyyy-MM-dd HH:mm:ss"
					      value-format="yyyy-MM-dd HH:mm:ss">
					    </el-date-picker>
                    </el-form-item>
                </el-col>
                <el-col span="24">
                    <el-form-item label="文章链接">
                        <el-input v-model="form.ImageLink" clearable></el-input>
                    </el-form-item>
                </el-col>                
                
            </el-row>
            <!--<el-row>
            	<el-col span="12">
                    <el-form-item label="备  注">
                        <el-input v-model="form.Remark" style="width: 540px;" clearable></el-input>
                    </el-form-item>
                </el-col>
            </el-row>-->
            <el-row>
                 <el-col span="24">
                    <el-form-item label="图片地址">
                        <el-input v-model="form.ImageUrl"  clearable></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
        </el-form>
        <div slot="footer" class="dialog-footer" style="margin-top:-30px;">
            <el-button size="small" v-on:click="dialogArticleFormVisible = false">取 消</el-button>
            <el-button type="primary" size="small" v-on:click="SaveArticle(form)">确 定</el-button>
        </div>
    </el-dialog>
</div>

<script>
    var ArticleVue;
    $(function () {
        NProgress.done();
        ArticleVue = new Vue({
            el: "#Article",
            data: {
                tableData: [],
                txtName:"",
                dialogArticleFormVisible: false,
                form: {},
                //uploadActionUrl:"/BaseSet/ArticleUpload",
                //fileList2: [],
                DicData:[],
                currentPage:1,
        		pagesize:10,
        		nodeList:[],
            	selectedOptions:[]
            },
            beforeCreate:function (){
            	var _self = this;
                $.ajax({
                    type: "get",
                    dataType: "json",
                    contentType: "application/json",
                    url: "/BaseSet/GetDicItemsByDicKey",
                    data:{
                    	key:"6E62949A-8EC7-42C4-B691-DEEB7483514C"
                    },
                    success: function (result) {
                        _self.DicData = result;
                    }
                });
            },
            created: function () {
                this.QueryData();
                this.GetNodes();
            },
            methods: {
            	dateFormat: function (row, column) {
                    var date = row[column.property];
                    if (date == undefined) {
                        return "";
                    }
                    return new Date(parseInt(date.substr(6, 13))).toLocaleDateString();
                    //return moment(date).format("YYYY-MM-DD HH:mm:ss");
                    //return new Date(parseInt(date.substr(6, 13))).toLocaleDateString();
                },
                ChangeDateFormat:function(timeSpan) {
				    var timeSpan = timeSpan.replace('Date','').replace('(','').replace(')','').replace(/\//g,'');
				    var d = new Date(parseInt(timeSpan));
				    return d;
				},
				GetNeedDateFormat:function(datetime){
					var d = new Date(datetime);  
					return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + d.getHours() + 					':' + d.getMinutes() + ':' + d.getSeconds(); 
				},
                handleAdd: function () {
                    var _self = this;
                    _self.form = {};
                    this.dialogArticleFormVisible = true;
                },
                handleEdit: function (ArticleId) {
                    var _self = this;
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        contentType: "application/json",
                        url: "/BaseSet/GetArticleByKey?pGuid=" + guid(),
                        data: {
                            id: ArticleId
                        },
                        success: function (result) {
                        	result.StartTime = _self.ChangeDateFormat(result.StartTime);
                        	result.EndTime = _self.ChangeDateFormat(result.EndTime);
                            _self.form = result;
                        }
                    });
                   
                    this.dialogArticleFormVisible = true;
                },
                QueryData: function () {
                    var _self = this;
                    var title = this.txtName;
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        contentType: "application/json",
                        url: "/BaseSet/GetArticlesByCondition?pGuid=" + guid(),
                        data: {
                            KeyName: title
                        },
                        success: function (result) {
                            ArticleVue.tableData = result;
                        },
                        error: function (json) {
                            _self.$message.error('加载图片信息失败');
                        }
                    });
                },
                SaveArticle: function (Article) {
                    var _self = this;
                    Article.StartTime= _self.GetNeedDateFormat(Article.StartTime);
                    Article.EndTime= _self.GetNeedDateFormat(Article.EndTime);
                    Article.ArticleGroup=_self.selectedOptions.join('-');
                    $.ajax({
                        type: "post",
                        dataType: "json",
                        url: "/BaseSet/SaveArticle",
                        data: Article,
                        success: function (result) {
                            if (result) {
                                _self.dialogArticleFormVisible = false;
                                _self.QueryData();
                                _self.$message({
                                    type: 'success',
                                    message: '保存成功!'
                                });
                            } else {
                                _self.$message.error('保存文章信息失败');
                            }
                        },
                        error: function (json) {
                            _self.$message.error('保存文章信息失败');
                        }
                    });
                },
                handleDisable: function (ArticleId, status) {
                    var _self = this;
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "/BaseSet/EnableArticle",
                        data: {
                            ArticleId: ArticleId,
                            status: status
                        },
                        success: function (result) {
                            if (result) {
                                _self.$message({
                                    type: 'success',
                                    message: '保存成功!'
                                });
                                _self.QueryData();
                            } else {
                                _self.$message({
                                    type: 'info',
                                    message: '保存失败!'
                                });
                            }
                        }
                    });
                },
//              handleRemove:function(file, fileList){
//	                $.ajax({
//	                        type: "get",
//	                        dataType: "json",
//	                        contentType: "application/json",
//	                        url: "/BaseSet/ArticleRemove",
//	                        success: function (result) {
//	                            //self.fileList2 = result;
//	                        }
//	                    });
//              },
                handleSizeChange: function (size) {
			        this.pagesize = size;
			    },
			    handleCurrentChange: function(currentPage){
			        this.currentPage = currentPage;
			    },
			    GetNodes:function(){
					var _self=this;
					$.ajax({
	                    type: "post",
	                    dataType: "json",
	                    url: "/WxClass/GetDicInfoList?pGuid=" + guid(),
	                    data:{
	                    	key:"6072f941-cc6f-48c6-9aea-c4eed1de04ae"
	                    },
	                    success: function (result) {
	                    	_self.nodeList=result
	                    },
	                    error: function (json) {
	                        
	                    }
	                });
				},
            }

        });
    })

    function guid() {
        function S4() {
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        }
        return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
    }


</script>